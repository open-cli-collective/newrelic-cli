name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # TAP_GITHUB_TOKEN (a PAT) is required to push to the open-cli-collective/homebrew-tap
      # repository. The default GITHUB_TOKEN only has access to this repository.
      - name: Update Homebrew Tap
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUM="${VERSION#v}"

          DARWIN_ARM64_SHA=$(grep "_darwin_arm64.tar.gz" dist/checksums.txt | cut -d' ' -f1)
          DARWIN_AMD64_SHA=$(grep "_darwin_amd64.tar.gz" dist/checksums.txt | cut -d' ' -f1)

          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/open-cli-collective/homebrew-tap.git
          cd homebrew-tap

          mkdir -p Formula

          cat > Formula/newrelic-cli.rb << 'FORMULAEOF'
          class NewrelicCli < Formula
            desc "Command-line interface for New Relic"
            homepage "https://github.com/open-cli-collective/newrelic-cli"
            license "MIT"
            version "VERSION_PLACEHOLDER"

            on_macos do
              on_arm do
                url "https://github.com/open-cli-collective/newrelic-cli/releases/download/v#{version}/newrelic-cli_v#{version}_darwin_arm64.tar.gz"
                sha256 "DARWIN_ARM64_PLACEHOLDER"
              end
              on_intel do
                url "https://github.com/open-cli-collective/newrelic-cli/releases/download/v#{version}/newrelic-cli_v#{version}_darwin_amd64.tar.gz"
                sha256 "DARWIN_AMD64_PLACEHOLDER"
              end
            end

            def install
              bin.install "newrelic-cli"
            end

            def caveats
              <<~EOS
                To configure newrelic-cli, run:
                  newrelic-cli config set-api-key
                  newrelic-cli config set-account-id <your-account-id>

                Or set environment variables:
                  NEWRELIC_API_KEY
                  NEWRELIC_ACCOUNT_ID
                  NEWRELIC_REGION (US or EU)
              EOS
            end

            test do
              assert_match "newrelic-cli", shell_output("#{bin}/newrelic-cli --help")
            end
          end
          FORMULAEOF

          sed -i "s/VERSION_PLACEHOLDER/${VERSION_NUM}/g" Formula/newrelic-cli.rb
          sed -i "s/DARWIN_ARM64_PLACEHOLDER/${DARWIN_ARM64_SHA}/g" Formula/newrelic-cli.rb
          sed -i "s/DARWIN_AMD64_PLACEHOLDER/${DARWIN_AMD64_SHA}/g" Formula/newrelic-cli.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update newrelic-cli to ${VERSION_NUM}"
          git push

  chocolatey:
    needs: goreleaser
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get checksums from release
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download "${{ github.ref_name }}" --pattern "checksums.txt" --dir .

          $checksums = Get-Content checksums.txt
          $x64Hash = ($checksums | Select-String "windows_amd64.zip").Line.Split()[0]
          $arm64Hash = ($checksums | Select-String "windows_arm64.zip").Line.Split()[0]

          Write-Host "x64 SHA256: $x64Hash"
          Write-Host "arm64 SHA256: $arm64Hash"

          echo "X64_HASH=$x64Hash" >> $env:GITHUB_ENV
          echo "ARM64_HASH=$arm64Hash" >> $env:GITHUB_ENV

      - name: Update version and checksums
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')

          # Update version in nuspec
          $nuspec = 'packaging/chocolatey/newrelic-cli.nuspec'
          (Get-Content $nuspec) -replace '<version>0.0.0</version>', "<version>$version</version>" | Set-Content $nuspec
          Write-Host "Updated nuspec to version $version"

          # Inject checksums into install script
          $script = 'packaging/chocolatey/tools/chocolateyInstall.ps1'
          $content = Get-Content $script -Raw
          $content = $content -replace 'CHECKSUM_AMD64_PLACEHOLDER', $env:X64_HASH
          $content = $content -replace 'CHECKSUM_ARM64_PLACEHOLDER', $env:ARM64_HASH
          Set-Content $script $content
          Write-Host "Injected checksums into install script"

      - name: Pack Chocolatey package
        shell: pwsh
        run: |
          cd packaging/chocolatey
          choco pack
          Get-ChildItem *.nupkg

      - name: Push to Chocolatey
        shell: pwsh
        run: |
          cd packaging/chocolatey
          choco push (Get-ChildItem *.nupkg).Name --source https://push.chocolatey.org/ --key ${{ secrets.CHOCOLATEY_API_KEY }}
